---
import Layout from "../../layouts/Layout.astro";
import Tooltip from "../../components/ui/Tooltip.astro";
import SenateGuide from "../../components/ui/SenateGuide";
import SenateClassExplorer from "../../components/ui/SenateClassExplorer";
import { fetchSenateOverview, fetchAllClass2Seats } from "../../lib/queries";

const { senateOverview } = await fetchSenateOverview();
const allClass2Seats = await fetchAllClass2Seats();

// Sort seats: competitive first (Toss-up, Lean, Likely), then Safe, alphabetical within each group
const ratingOrder: Record<string, number> = {
  "Toss-up": 0, "Lean D": 1, "Lean R": 1, "Likely D": 2, "Likely R": 2,
  "Safe D": 3, "Safe R": 3,
};
const sortedSeats = [...allClass2Seats].sort((a, b) => {
  const aOrder = ratingOrder[a.rating] ?? 4;
  const bOrder = ratingOrder[b.rating] ?? 4;
  if (aOrder !== bOrder) return aOrder - bOrder;
  return a.state.localeCompare(b.state);
});

function ratingColor(rating: string) {
  switch (rating) {
    case "Safe R":
    case "Likely R":
      return "text-gop bg-gop-light";
    case "Lean R":
      return "text-gop bg-gop-light/50";
    case "Toss-up":
      return "text-tossup bg-amber-50";
    case "Lean D":
      return "text-dem bg-dem-light/50";
    case "Safe D":
    case "Likely D":
      return "text-dem bg-dem-light";
    default:
      return "text-slate-500 bg-slate-100";
  }
}
---

<Layout title="Senate" description="How the U.S. Senate works, plus the current balance of power and all seats up for election.">
  <section class="max-w-5xl mx-auto py-16 px-4">
    <h1 class="text-3xl md:text-4xl font-bold mb-2">The U.S. Senate</h1>
    <p class="text-lg text-slate-500 mb-6">
      {senateOverview.seatsUpForElection} <Tooltip term="Class II" definition="The Senate is split into 3 classes. Each class comes up for election every 6 years. Class II is up in 2026." /> seats + {senateOverview.specialElections} <Tooltip term="special elections" definition="Elections held to fill seats that were vacated early, like when a senator resigns to take another job." /> up this cycle.
      Currently {senateOverview.currentSplit.republican}R - {senateOverview.currentSplit.democrat}D.
    </p>

    <!-- Guide wizard -->
    <div class="mb-10">
      <SenateGuide
        client:load
        overview={senateOverview}
      />
    </div>

    <!-- ═══════════════════════════════════════════ -->
    <!-- Senate 101 — Evergreen educational content -->
    <!-- ═══════════════════════════════════════════ -->

    <div id="101" class="mb-12">
      <h2 class="text-2xl md:text-3xl font-bold mb-6">Senate 101</h2>

      <div class="space-y-8 max-w-3xl">
        <p class="text-lg text-slate-600">
          The U.S. Senate is often called "the world's greatest deliberative body." Every state gets exactly two senators, regardless of population. That means Wyoming (population ~580,000) has the same Senate representation as California (population ~39 million).
        </p>

        <div class="bg-slate-50 rounded-xl p-6">
          <h3 class="text-xl font-bold mb-4">Key Facts</h3>
          <div class="grid grid-cols-2 gap-4 text-center">
            <div>
              <div class="text-3xl font-bold text-dem">100</div>
              <div class="text-sm text-slate-500">Total Senators</div>
            </div>
            <div>
              <div class="text-3xl font-bold text-dem">6 years</div>
              <div class="text-sm text-slate-500">Term Length</div>
            </div>
            <div>
              <div class="text-3xl font-bold text-dem">3</div>
              <div class="text-sm text-slate-500">Classes</div>
            </div>
            <div>
              <div class="text-3xl font-bold text-dem">51</div>
              <div class="text-sm text-slate-500">Seats for Majority</div>
            </div>
          </div>
        </div>

        <h3 class="text-2xl font-bold">The 3-Class System</h3>
        <p class="text-slate-600">
          To avoid replacing the entire Senate at once, senators are divided into three groups called "classes":
        </p>
        <SenateClassExplorer client:visible />

        <h3 class="text-2xl font-bold">Special Elections</h3>
        <p class="text-slate-600">
          When a senator leaves office before their term is up (resignation, death, or appointment to another role), their state may hold a <strong>special election</strong> to fill the seat. In 2026, there are two special elections:
        </p>
        <ul class="list-disc list-inside text-slate-600 space-y-1">
          <li><strong>Ohio</strong> &mdash; JD Vance resigned to become Vice President</li>
          <li><strong>Florida</strong> &mdash; Marco Rubio resigned to become Secretary of State</li>
        </ul>

        <h3 class="text-2xl font-bold">What Does a Senator Do?</h3>
        <ul class="list-disc list-inside text-slate-600 space-y-2">
          <li>Writes and votes on legislation</li>
          <li>Confirms (or rejects) the president's nominees for judges, cabinet members, and ambassadors</li>
          <li>Ratifies treaties with foreign nations</li>
          <li>Conducts impeachment trials</li>
          <li>Represents their entire state's interests</li>
        </ul>
      </div>
    </div>

    <!-- ═══════════════════════════════════════════ -->
    <!-- This Cycle — Dynamic data from DB          -->
    <!-- ═══════════════════════════════════════════ -->

    <div class="border-t border-slate-200 pt-10">

      <!-- Rating Legend -->
      <div class="flex flex-wrap gap-3 mb-10 text-xs">
        <span class="text-slate-400 font-medium self-center">Ratings:</span>
        <span class="px-2 py-1 rounded-full bg-gop-light text-gop font-medium">Safe R</span>
        <span class="px-2 py-1 rounded-full bg-gop-light/50 text-gop font-medium">Lean R</span>
        <span class="px-2 py-1 rounded-full bg-amber-50 text-tossup font-medium">Toss-up</span>
        <span class="px-2 py-1 rounded-full bg-dem-light/50 text-dem font-medium">Lean D</span>
        <span class="px-2 py-1 rounded-full bg-dem-light text-dem font-medium">Safe D</span>
        <a href="/glossary#lean" class="text-slate-400 underline self-center">What do these mean?</a>
      </div>

      <!-- Path to Majority -->
      <div class="bg-slate-50 rounded-xl p-6 mb-10">
        <h2 class="text-xl font-bold mb-4">Path to Majority</h2>
        <div class="flex items-center gap-4 mb-4">
          <div class="flex-1 bg-gop rounded-l-full h-8 flex items-center justify-center text-white text-sm font-bold" style={`width: ${senateOverview.currentSplit.republican}%`}>
            {senateOverview.currentSplit.republican} R
          </div>
          <div class="flex-1 bg-dem rounded-r-full h-8 flex items-center justify-center text-white text-sm font-bold" style={`width: ${senateOverview.currentSplit.democrat}%`}>
            {senateOverview.currentSplit.democrat} D
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 text-center text-sm">
          <div>
            <span class="font-bold text-dem text-lg">{senateOverview.demsNeedToFlip}</span>
            <p class="text-slate-500">seats Dems need to flip</p>
          </div>
          <div>
            <span class="font-bold text-gop text-lg">{senateOverview.gopsCanLose}</span>
            <p class="text-slate-500">max seats GOP can lose</p>
          </div>
        </div>
      </div>

      <!-- Explore races CTA -->
      <div class="bg-slate-50 rounded-xl p-6 mb-10 text-center">
        <h2 class="text-xl font-bold mb-2">Explore your state's races</h2>
        <p class="text-sm text-slate-500 mb-4">
          Click your state on the map to see Senate candidates, ballot measures, and more.
        </p>
        <div class="flex flex-wrap gap-3 justify-center">
          <a href="/map" class="inline-flex items-center px-5 py-2.5 bg-navy text-white rounded-lg text-sm font-medium hover:bg-slate-700 transition-colors">
            Interactive Map &rarr;
          </a>
          <a href="/find-your-ballot" class="inline-flex items-center px-5 py-2.5 border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors">
            Find Your Ballot &rarr;
          </a>
          <a href="/calendar" class="inline-flex items-center px-5 py-2.5 border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors">
            Primary Calendar &rarr;
          </a>
        </div>
      </div>

      <!-- All 33 Class II Seats — flat list sorted by competitiveness -->
      <div id="all-seats" class="mb-10">
        <h2 class="text-2xl font-bold mb-2">All {sortedSeats.length} Senate Seats Up This Cycle</h2>
        <p class="text-sm text-slate-500 mb-6">
          Sorted by competitiveness. Competitive races are highlighted.
          Plus 2 special elections in Ohio and Florida (Class III seats vacated early).
        </p>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
          {sortedSeats.map((seat) => (
            <div class={`rounded-lg border p-3 text-sm ${seat.isCompetitive ? "border-tossup/50 bg-amber-50/30" : "border-slate-200"}`}>
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold text-slate-800">{seat.state}</div>
                  <div class="text-xs text-slate-500">{seat.senator}</div>
                </div>
                <span class={`text-[10px] font-bold px-2 py-0.5 rounded-full ${ratingColor(seat.rating)}`}>
                  {seat.rating}
                </span>
              </div>
              {seat.isCompetitive && (
                <a href="/map" class="text-[10px] text-tossup font-medium mt-1 inline-block hover:underline">View on map</a>
              )}
            </div>
          ))}
        </div>
      </div>

    </div>
  </section>
</Layout>
