---
import Layout from "../layouts/Layout.astro";
import type { NewsItem } from "../types";
import Parser from "rss-parser";

const parser = new Parser();

const FEEDS = [
  { url: "https://www.propublica.org/feeds/propublica/main", source: "ProPublica" as const },
  { url: "https://www.pbs.org/newshour/feeds/rss/politics", source: "PBS NewsHour" as const },
  { url: "https://www.theguardian.com/us-news/us-politics/rss", source: "The Guardian" as const },
];

const allItems: NewsItem[] = [];

for (const feed of FEEDS) {
  try {
    const parsed = await parser.parseURL(feed.url);
    for (const item of parsed.items ?? []) {
      allItems.push({
        title: item.title ?? "Untitled",
        link: item.link ?? "#",
        description: item.contentSnippet ?? item.content ?? "",
        pubDate: item.pubDate ?? "",
        source: feed.source,
        categories: (item.categories ?? []).map((cat: unknown) =>
          typeof cat === "string" ? cat : (cat as { _: string })._ ?? String(cat)
        ),
        author: item.creator ?? item["dc:creator"] ?? undefined,
      });
    }
  } catch (e) {
    console.error(`Failed to fetch ${feed.source} feed:`, e);
  }
}

// Sort newest first
allItems.sort((a, b) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime());

// Limit to 30 items
const items = allItems.slice(0, 30);

// All items are rendered; filtering happens client-side via JS
const filtered = items;

function formatDate(dateStr: string): string {
  try {
    return new Date(dateStr).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  } catch {
    return dateStr;
  }
}

function truncate(str: string, max: number): string {
  if (str.length <= max) return str;
  return str.slice(0, max).trimEnd() + "...";
}
---

<Layout title="News" description="Latest political news from ProPublica, PBS NewsHour, and The Guardian.">
  <section class="py-16 px-4">
    <div class="max-w-5xl mx-auto">
      <h1 class="text-4xl font-black tracking-tight text-navy mb-2">News</h1>
      <p class="text-slate-500 mb-8">
        Latest political coverage from trusted sources, updated with each site build.
      </p>

      <!-- Source filter -->
      <div class="mb-10">
        <select
          id="source-filter"
          class="text-sm font-medium px-4 py-2 pr-8 rounded-full border border-slate-200 bg-white text-slate-700 appearance-none cursor-pointer hover:border-slate-400 focus:outline-none focus:border-navy transition-colors"
          style="background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 20 20%22 fill=%22%2394a3b8%22%3E%3Cpath fill-rule=%22evenodd%22 d=%22M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z%22 clip-rule=%22evenodd%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1rem;"
        >
          <option value="all">All Sources</option>
          <option value="ProPublica">ProPublica</option>
          <option value="PBS NewsHour">PBS NewsHour</option>
          <option value="The Guardian">The Guardian</option>
        </select>
      </div>

      <!-- Articles -->
      {filtered.length === 0 ? (
        <p class="text-slate-400 text-center py-12">No articles found.</p>
      ) : (
        <div class="space-y-6">
          {filtered.map((item) => (
            <a
              href={item.link}
              target="_blank"
              rel="noopener noreferrer"
              data-source={item.source}
              class="news-card group block border border-slate-200 rounded-lg p-6 hover:border-slate-400 transition-colors"
            >
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-3 mb-2">
                    <span
                      class:list={[
                        "text-xs font-semibold px-2.5 py-0.5 rounded-full",
                        item.source === "ProPublica"
                          ? "bg-slate-800 text-white"
                          : item.source === "The Guardian"
                            ? "bg-blue-900 text-white"
                            : "bg-indigo-100 text-indigo-700",
                      ]}
                    >
                      {item.source}
                    </span>
                    <span class="text-xs text-slate-400">{formatDate(item.pubDate)}</span>
                    {item.author && (
                      <span class="text-xs text-slate-400 hidden sm:inline">by {item.author}</span>
                    )}
                  </div>
                  <h2 class="text-lg font-bold text-navy group-hover:text-dem transition-colors mb-2 leading-snug">
                    {item.title}
                  </h2>
                  <p class="text-sm text-slate-500 leading-relaxed">
                    {truncate(item.description, 200)}
                  </p>
                  {item.categories && item.categories.length > 0 && (
                    <div class="flex flex-wrap gap-1.5 mt-3">
                      {item.categories.slice(0, 4).map((cat) => (
                        <span class="text-xs text-slate-400 bg-slate-50 px-2 py-0.5 rounded">
                          {cat}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
                <span class="text-slate-300 group-hover:text-dem transition-colors mt-1 shrink-0">
                  &rarr;
                </span>
              </div>
            </a>
          ))}
        </div>
      )}

      <p class="text-xs text-slate-400 mt-12 text-center">
        Articles sourced from <a href="https://www.propublica.org" class="underline hover:text-slate-600" target="_blank" rel="noopener noreferrer">ProPublica</a>, <a href="https://www.pbs.org/newshour" class="underline hover:text-slate-600" target="_blank" rel="noopener noreferrer">PBS NewsHour</a>, and <a href="https://www.theguardian.com/us-news/us-politics" class="underline hover:text-slate-600" target="_blank" rel="noopener noreferrer">The Guardian</a>.
        This page links to original reporting &mdash; The Midterm Project does not host or modify this content.
      </p>
    </div>
  </section>
</Layout>

<script>
  const select = document.getElementById("source-filter") as HTMLSelectElement;
  const cards = document.querySelectorAll<HTMLAnchorElement>(".news-card");

  select.addEventListener("change", () => {
    const filter = select.value;
    cards.forEach((card) => {
      card.style.display =
        filter === "all" || card.dataset.source === filter ? "" : "none";
    });
  });
</script>
